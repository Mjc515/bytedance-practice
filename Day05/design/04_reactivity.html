<div id="app">
  {{title}}
  <comp></comp>
</div>

<script>
  // 1.基本结构
  const Vue = {
    // 扩展性
    // 平台无关性
    createRenderer({ querySelector, insert }) {
      return {
        createApp(options) {
          return {
            mount(selector) {
              console.log("mount~");
              const parent = querySelector(selector);
              if (!options.render) {
                options.render = this.compile(parent.innerHTML);
              }
              if (options.setup) {
                this.setupState = options.setup();
              }
              if (options.data) {
                this.data = options.data();
              }
              const proxyData = new Proxy(this, {
                get(target, key) {
                  if (target.setupState && key in target.setupState) {
                    return target.setupState[key];
                  }
                  return target.data[key];
                },
                set(target, key, val) {
                  if (target.setupState && key in target.setupState) {
                    target.setupState[key] = val;
                  } else {
                    target.data[key] = val;
                  }
                },
              });
              this.update = function() {
                const el = options.render.call(proxyData);
                // 3.追加到宿主
                parent.innerHTML = "";
                insert(el, parent)
              }
              this.update()
              
            },
            compile(template) {
              return function render() {
                const h3 = document.createElement("h3");
                h3.textContent = this.title;
                return h3;
              };
            }
          };
        },
      };
    },

    createApp(options) {
      // 创建一个web平台特有渲染器
      const renderer = Vue.createRenderer({
        querySelector(sel) {
          return document.querySelector(sel);
        },
        insert(el, parent) {
          parent.appendChild(el);
        },
      });
      return renderer.createApp(options);
    },
  };
</script>
<script>
  // 数据拦截访问 => 响应式
  function reactive(obj) {
    return new Proxy(obj, {
      get(target, key){
        console.log('get key:', key)
        return target[key]
        // return Reflect.get(target, key)
      },
      set(target, key, val){
        console.log('set key:', key)
        target[key] = val
        // Reflect.set(target, key)
        // 通知更新
        app.update()
      }
    })
  }


  const app = Vue.createApp({
    setup() {
      const state = reactive({
        title: 'vue3, hello!'
      })
      setTimeout(() => {
        state.title = '2s后 hello, vue3!'
      },2000)
      return state
    },
  });

  app.mount("#app");
</script>
